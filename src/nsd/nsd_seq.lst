ca65 V2.13.3 - (C) Copyright 1998-2012 Ullrich von Bassewitz
Main file   : nsd_seq.s
Current file: nsd_seq.s

000000r 1               
000000r 1               	.setcpu		"6502"
000000r 1               
000000r 1               	.export		nsd_sequence
000000r 1               
000000r 1               	.import		_nsd_snd_keyon
000000r 1               	.import		_nsd_snd_keyoff
000000r 1               	.import		_nsd_snd_sweep
000000r 1               	.import		nsd_work
000000r 1               	.importzp	nsd_work_zp
000000r 1               
000000r 1               	.include	"nes.inc"
000000r 2               ;
000000r 2               ; NES definitions. By Groepaz/Hitmem.
000000r 2               ;
000000r 2               
000000r 2               
000000r 2               ;; FIXME: optimize zeropage usage
000000r 2               
000000r 2               SCREEN_PTR	= $62           ;2
000000r 2               CRAM_PTR        = $64           ;2
000000r 2               CHARCOLOR	= $66
000000r 2               BGCOLOR		= $67
000000r 2               RVS		= $68
000000r 2               CURS_X		= $69
000000r 2               CURS_Y		= $6a
000000r 2               
000000r 2               tickcount       = $6b           ;2
000000r 2               
000000r 2               VBLANK_FLAG	= $70
000000r 2               
000000r 2               ringbuff        = $0200
000000r 2               ringwrite       = $71
000000r 2               ringread        = $72
000000r 2               ringcount       = $73
000000r 2               
000000r 2               ppuhi           = $74
000000r 2               ppulo           = $75
000000r 2               ppuval          = $76
000000r 2               
000000r 2               screenrows 	= (30-1)
000000r 2               charsperline    = 32
000000r 2               xsize           = charsperline
000000r 2               
000000r 2               ;; PPU defines
000000r 2               
000000r 2               PPU_CTRL1      	= $2000
000000r 2               PPU_CTRL2	= $2001
000000r 2               PPU_STATUS	= $2002
000000r 2               PPU_SPR_ADDR	= $2003
000000r 2               PPU_SPR_IO  	= $2004
000000r 2               PPU_VRAM_ADDR1	= $2005
000000r 2               PPU_VRAM_ADDR2	= $2006
000000r 2               PPU_VRAM_IO	= $2007
000000r 2               
000000r 2               ;; APU defines
000000r 2               
000000r 2               APU_PULSE1CTRL  = $4000         ; Pulse #1 Control Register (W)
000000r 2               APU_PULSE1RAMP  = $4001         ; Pulse #1 Ramp Control Register (W)
000000r 2               APU_PULSE1FTUNE = $4002         ; Pulse #1 Fine Tune (FT) Register (W)
000000r 2               APU_PULSE1CTUNE = $4003         ; Pulse #1 Coarse Tune (CT) Register (W)
000000r 2               APU_PULSE2CTRL  = $4004         ; Pulse #2 Control Register (W)
000000r 2               APU_PULSE2RAMP  = $4005         ; Pulse #2 Ramp Control Register (W)
000000r 2               APU_PULSE2FTUNE = $4006         ; Pulse #2 Fine Tune Register (W)
000000r 2               APU_PULSE2STUNE = $4007         ; Pulse #2 Coarse Tune Register (W)
000000r 2               APU_TRICTRL1    = $4008         ; Triangle Control Register #1 (W)
000000r 2               APU_TRICTRL2    = $4009         ; Triangle Control Register #2 (?)
000000r 2               APU_TRIFREQ1    = $400A         ; Triangle Frequency Register #1 (W)
000000r 2               APU_TRIFREQ2    = $400B         ; Triangle Frequency Register #2 (W)
000000r 2               APU_NOISECTRL   = $400C         ; Noise Control Register #1 (W)
000000r 2               ;;APU_ = $400D  ; Unused (???)
000000r 2               APU_NOISEFREQ1  = $400E         ; Noise Frequency Register #1 (W)
000000r 2               APU_NOISEFREQ2  = $400F         ; Noise Frequency Register #2 (W)
000000r 2               APU_MODCTRL     = $4010         ; Delta Modulation Control Register (W)
000000r 2               APU_MODDA       = $4011         ; Delta Modulation D/A Register (W)
000000r 2               APU_MODADDR     = $4012         ; Delta Modulation Address Register (W)
000000r 2               APU_MODLEN      = $4013         ; Delta Modulation Data Length Register (W)
000000r 2               APU_SPR_DMA    	= $4014         ; Sprite DMA Register (W)
000000r 2               APU_CHANCTRL   	= $4015         ; Sound/Vertical Clock Signal Register (R)
000000r 2               APU_PAD1       	= $4016         ; Joypad #1 (RW)
000000r 2               APU_PAD2	= $4017         ; Joypad #2/SOFTCLK (RW)
000000r 2               
000000r 2               
000000r 2               CH_HLINE    	= 11
000000r 2               CH_VLINE    	= 14
000000r 2               CH_ULCORNER 	= 176
000000r 2               CH_URCORNER 	= 174
000000r 2               CH_LLCORNER 	= 173
000000r 2               CH_LRCORNER 	= 189
000000r 2               CH_TTEE	    	= 178
000000r 2               CH_RTEE	    	= 179
000000r 2               CH_BTEE	    	= 177
000000r 2               CH_LTEE	    	= 171
000000r 2               CH_CROSS    	= 123
000000r 2               CH_CURS_UP     	= 145
000000r 2               CH_CURS_DOWN	= 17
000000r 2               CH_CURS_LEFT	= 157
000000r 2               CH_CURS_RIGHT	= 29
000000r 2               CH_PI		= 126
000000r 2               CH_DEL		= 20
000000r 2               CH_INS		= 148
000000r 2               CH_ENTER        = 10
000000r 2               CH_STOP         = 3
000000r 2               CH_ESC          = 27
000000r 2               
000000r 2               
000000r 1               	.include	"nsd.inc"
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;General Define
000000r 2               .scope	nsd
000000r 2               	APU_Track	= 5		;
000000r 2               
000000r 2               	TR_FDS		= APU_Track * 2
000000r 2               	.ifdef	FDS
000000r 2               		FDS_Track	= 1		;
000000r 2               	.else
000000r 2               		FDS_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	TR_VRC6		= TR_FDS + FDS_Track * 2
000000r 2               	.ifdef	VRC6
000000r 2               		VRC6_Track	= 3		;
000000r 2               	.else
000000r 2               		VRC6_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	TR_VRC7		= TR_VRC6 + VRC6_Track * 2
000000r 2               	.ifdef	VRC7
000000r 2               		VRC7_Track	= 6		;
000000r 2               	.else
000000r 2               		VRC7_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	TR_MMC5		= TR_VRC7 + VRC7_Track * 2
000000r 2               	.ifdef	MMC5
000000r 2               		MMC5_Track	= 2		; (without DPCM)
000000r 2               	.else
000000r 2               		MMC5_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	TR_N163		= TR_MMC5 + MMC5_Track * 2
000000r 2               	.ifdef	N163
000000r 2               		N163_Track	= 8		;
000000r 2               	.else
000000r 2               		N163_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	TR_PSG		= TR_N163 + N163_Track * 2
000000r 2               	.ifdef	PSG
000000r 2               		PSG_Track	= 3		;
000000r 2               	.else
000000r 2               		PSG_Track	= 0		;
000000r 2               	.endif
000000r 2               
000000r 2               	BGM_Track	= APU_Track + FDS_Track + VRC6_Track + VRC7_Track + MMC5_Track + N163_Track + PSG_Track
000000r 2               	SE_Track	= 2		;
000000r 2               
000000r 2               	Track		= BGM_Track + SE_Track
000000r 2               
000000r 2               	TR_BGM1		= 0
000000r 2               	TR_BGM2		= 2
000000r 2               	TR_BGM3		= 4
000000r 2               	TR_BGM4		= 6
000000r 2               	TR_BGM5		= 8
000000r 2               	TR_SE1		= BGM_Track * 2 + 0
000000r 2               	TR_SE2		= BGM_Track * 2 + 2
000000r 2               
000000r 2               .endscope
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;FDS define
000000r 2               
000000r 2               FDS_Wave_Table		= $4040		; to $407F
000000r 2               FDS_Volume		= $4080
000000r 2               FDS_FTUNE		= $4082
000000r 2               FDS_CTUNE		= $4083
000000r 2               FDS_Sweep_Envelope	= $4084
000000r 2               FDS_Sweep_Bias		= $4085
000000r 2               FDS_Mod_FTUNE		= $4086
000000r 2               FDS_Mod_CTUNE		= $4087
000000r 2               FDS_Mod_Append		= $4088
000000r 2               FDS_Write_Enable	= $4089
000000r 2               FDS_Envelope_Speed	= $408A
000000r 2               FDS_Volume_Gain		= $4090		;$4080's value
000000r 2               FDS_Sweep_Gain		= $4092		;$4084's value
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;VRC6 define
000000r 2               
000000r 2               VRC6_Frequency		= $9003
000000r 2               VRC6_Pulse1_CTRL	= $9000
000000r 2               VRC6_Pulse1_FTUNE	= $9001
000000r 2               VRC6_Pulse1_CTUNE	= $9002
000000r 2               VRC6_Pulse2_CTRL	= $A000
000000r 2               VRC6_Pulse2_FTUNE	= $A001
000000r 2               VRC6_Pulse2_CTUNE	= $A002
000000r 2               VRC6_SAW_CTRL		= $B000
000000r 2               VRC6_SAW_FTUNE		= $B001
000000r 2               VRC6_SAW_CTUNE		= $B002
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;VRC7 define
000000r 2               
000000r 2               VRC7_Resister		= $9010		;wait  6 clk
000000r 2               VRC7_Data		= $9030		;wait 42 clk
000000r 2               
000000r 2               VRC7_Patch0		= $00
000000r 2               VRC7_Patch1		= $01
000000r 2               VRC7_Patch2		= $02
000000r 2               VRC7_Patch3		= $03
000000r 2               VRC7_Patch4		= $04
000000r 2               VRC7_Patch5		= $05
000000r 2               VRC7_Patch6		= $06
000000r 2               VRC7_Patch7		= $07
000000r 2               
000000r 2               VRC7_Frequency		= $10
000000r 2               VRC7_Octave		= $20
000000r 2               VRC7_Volume		= $30
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;MMC5 define
000000r 2               
000000r 2               MMC5_Pulse1_CTRL	= $5000         ; Pulse_ #1 Control Register (W)
000000r 2               MMC5_Pulse1_FTUNE	= $5002         ; Pulse_ #1 Fine Tune (FT) Register (W)
000000r 2               MMC5_Pulse1_CTUNE	= $5003         ; Pulse_ #1 Coarse Tune (CT) Register (W)
000000r 2               MMC5_Pulse2_CTRL	= $5004         ; Pulse_ #2 Control Register (W)
000000r 2               MMC5_Pulse2_FTUNE	= $5006         ; Pulse_ #2 Fine Tune Register (W)
000000r 2               MMC5_Pulse2_STUNE	= $5007         ; Pulse_ #2 Coarse Tune Register (W)
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;N163 define
000000r 2               
000000r 2               N163_Resister		= $F800
000000r 2               N163_Data		= $4800
000000r 2               
000000r 2               N163_Frequency_Low	= $40
000000r 2               N163_Frequency_Middle	= $42
000000r 2               N163_Frequency_High	= $44
000000r 2               N163_Waveform		= $46
000000r 2               N163_Volume		= $47
000000r 2               N163_EnableChannel	= $7F
000000r 2               
000000r 2               ;---------------------------------------
000000r 2               ;PSG define
000000r 2               
000000r 2               PSG_Register		= $C000
000000r 2               PSG_Data		= $E000
000000r 2               
000000r 2               ;=======================================================================
000000r 2               ;	Working Struct define in Zero-page area
000000r 2               ;-----------------------------------------------------------------------
000000r 2               .Struct		NSD_Envelop
000000r 2               	V		.byte		;Volume & Voice (ch3:Tempo / ch5:Tempo_ctr)
000000r 2               	F		.byte		;Frequency & Note
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Length_Cnt
000000r 2               	counter		.byte		;now length of note
000000r 2               	gate		.byte		;length - u
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_work_zp
000000r 2               	_ptr		.word					;00 General pointer value
000000r 2               	_tmp		.word					;02 General value
000000r 2               	flag		.byte					;04 flag
000000r 2               	channel		.byte					;05 channel (y resister)
000000r 2               	Sequence_ptr	.word			nsd::Track	;06 Address of playing sequence
000000r 2               	Length		.tag	NSD_Length_Cnt	nsd::Track	;16 Length Counter
000000r 2               	Envelop		.tag	NSD_Envelop	nsd::Track	;26 Envelop counter
000000r 2               .Endstruct
000000r 2               
000000r 2               ; 6 + ( 6 [Byte] * 28 [ch] ) = 174
000000r 2               
000000r 2               ;=======================================================================
000000r 2               ;	Working  Struct define in RAM area
000000r 2               ;-----------------------------------------------------------------------
000000r 2               
000000r 2               .Struct		NSD_Flag
000000r 2               	flag		.byte		;flag
000000r 2               	gatemode	.byte		;gate mode
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_length
000000r 2               	length		.byte		;`l' command value
000000r 2               	tai		.byte		;flag of Tai & Slur
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_gatetime
000000r 2               	q		.byte		;`q' command value
000000r 2               	u		.byte		;`u' command value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_note
000000r 2               	note		.byte		;`note' command value (bit 7 = `H' : rest)
000000r 2               	octave		.byte		;`o' command value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Detune
000000r 2               	cent		.byte		;`D' command value
000000r 2               	fine		.byte		;`D%' command value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Por_Lv
000000r 2               	target		.byte		;`P' target
000000r 2               	depth		.byte		;`P' add value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Por_Co
000000r 2               	count		.byte		;rate control
000000r 2               	rate		.byte		;now depth
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Trans
000000r 2               	trans		.byte		;`_' command value
000000r 2               	onetime		.byte		;`'', `"' command value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Repeat
000000r 2               	count1		.byte		;counter of repeat(A)
000000r 2               	count2		.byte		;counter of repeat(B)
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_volume
000000r 2               	volume		.byte		;`v' & `vR' command value
000000r 2               	volume_env	.byte		;now envelop volume
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_voice
000000r 2               	voice		.byte		;`@R' command value (upper 4bit)
000000r 2               	voice_set	.byte		;deveice setting value
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Env_V_Ptr
000000r 2               	Volume		.byte		;Volume
000000r 2               	Voice		.byte		;Voice
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Env_F_Ptr
000000r 2               	Frequency	.byte		;Freeuqncy
000000r 2               	Note		.byte		;Note
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_Env_F_Now
000000r 2               	Frequency	.byte		;now envelop Freeuqncy
000000r 2               	Note		.byte		;now envelop Note
000000r 2               .Endstruct
000000r 2               
000000r 2               .Struct		NSD_work
000000r 2               	Flag		.tag	NSD_Flag	nsd::Track	;flag
000000r 2               	Length		.tag	NSD_length	nsd::Track	;note length [tick]
000000r 2               	Gatetime	.tag	NSD_gatetime	nsd::Track	;gate time [tick]
000000r 2               	Note		.tag	NSD_note	nsd::Track	;octave and note command
000000r 2               	Detune		.tag	NSD_Detune	nsd::Track	;detune
000000r 2               	Por_Lv		.tag	NSD_Por_Lv	nsd::Track	;Portamento
000000r 2               	Por_Co		.tag	NSD_Por_Co	nsd::Track	;Portamento
000000r 2               	Por_now		.word			nsd::Track	;Portamento
000000r 2               	Trans		.tag	NSD_Trans	nsd::Track	;Repeat and Transpose
000000r 2               	Repeat		.tag	NSD_Repeat	nsd::Track	;Repeat and Transpose
000000r 2               	Volume		.tag	NSD_volume	nsd::Track	;volume
000000r 2               	Voice		.tag	NSD_voice	nsd::Track	;voice
000000r 2               	Env_F_Now	.tag	NSD_Env_F_Now	nsd::Track	;Now value of envelop
000000r 2               	Env_V_Ptr	.tag	NSD_Env_V_Ptr	nsd::Track	;Address of envelop
000000r 2               	Env_F_Ptr	.tag	NSD_Env_F_Ptr	nsd::Track	;Address of envelop
000000r 2               	Envelop_Volume	.word			nsd::Track	;Pointer of envelop
000000r 2               	Envelop_Voice	.word			nsd::Track	;Pointer of envelop
000000r 2               	Envelop_Freq	.word			nsd::Track	;Pointer of envelop
000000r 2               	Envelop_Note	.word			nsd::Track	;Pointer of envelop
000000r 2               	Frequency	.word			nsd::Track	;Setting frequency
000000r 2               	Frequency_Set	.word			nsd::Track	;Setting frequency for Device
000000r 2               	SubRoutine	.word			nsd::Track	;Pointer of sub-routine return address
000000r 2               	Repeat2		.word			nsd::Track	;Pointer of repeat2 goto point
000000r 2               .Endstruct
000000r 2               
000000r 2               ;=======================================================================
000000r 2               ;	Defines for work structures
000000r 2               ;-----------------------------------------------------------------------
000000r 2               
000000r 2               .scope	nsd_flag
000000r 2               	BGM	= $01
000000r 2               	SE	= $02
000000r 2               .endscope
000000r 2               
000000r 2               ;Zero Page Works
000000r 2               .define	__ptr		nsd_work_zp + NSD_work_zp::_ptr
000000r 2               .define	__tmp		nsd_work_zp + NSD_work_zp::_tmp
000000r 2               .define	__flag		nsd_work_zp + NSD_work_zp::flag
000000r 2               .define	__channel	nsd_work_zp + NSD_work_zp::channel
000000r 2               .define	__Sequence_ptr	nsd_work_zp + NSD_work_zp::Sequence_ptr
000000r 2               .define	__Length_ctr	nsd_work_zp + NSD_work_zp::Length + NSD_Length_Cnt::counter
000000r 2               .define	__Gate		nsd_work_zp + NSD_work_zp::Length + NSD_Length_Cnt::gate
000000r 2               .define	__Envelop_V	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V	;upper 4bit Voice / lower 4bit:Volume
000000r 2               .define	__Envelop_F	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::F	;upper 4bit:Note  / lower 4bit:Frequency
000000r 2               .define	__Tempo		nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V + nsd::TR_BGM3
000000r 2               .define	__Tempo_ctr	nsd_work_zp + NSD_work_zp::Envelop + NSD_Envelop::V + nsd::TR_BGM5
000000r 2               
000000r 2               .scope	nsd_chflag
000000r 2               	SE1	= $40
000000r 2               	SE2	= $80
000000r 2               	KeyOff	= $03		;00	Key Off	: Vol = 0
000000r 2               				;01	Key Off	: Release command
000000r 2               				;10	Key Off	:  envelop
000000r 2               				;11	Note On	: (envelop)
000000r 2               .endscope
000000r 2               
000000r 2               ;RAM Works
000000r 2               .define	__chflag	nsd_work + NSD_work::Flag + NSD_Flag::flag
000000r 2               .define	__gatemode	nsd_work + NSD_work::Flag + NSD_Flag::gatemode
000000r 2               .define	__tai		nsd_work + NSD_work::Length + NSD_length::tai
000000r 2               .define	__length	nsd_work + NSD_work::Length + NSD_length::length
000000r 2               .define	__gate_q	nsd_work + NSD_work::Gatetime + NSD_gatetime::q
000000r 2               .define	__gate_u	nsd_work + NSD_work::Gatetime + NSD_gatetime::u
000000r 2               .define __note		nsd_work + NSD_work::Note + NSD_note::note
000000r 2               .define	__octave	nsd_work + NSD_work::Note + NSD_note::octave
000000r 2               .define	__detune_cent	nsd_work + NSD_work::Detune + NSD_Detune::cent
000000r 2               .define	__detune_fine	nsd_work + NSD_work::Detune + NSD_Detune::fine
000000r 2               .define	__por_target	nsd_work + NSD_work::Por_Lv + NSD_Por_Lv::target
000000r 2               .define	__por_depth	nsd_work + NSD_work::Por_Lv + NSD_Por_Lv::depth
000000r 2               .define	__por_ctr	nsd_work + NSD_work::Por_Co + NSD_Por_Co::count
000000r 2               .define	__por_rate	nsd_work + NSD_work::Por_Co + NSD_Por_Co::rate
000000r 2               .define __por_now	nsd_work + NSD_work::Por_now
000000r 2               .define	__trans		nsd_work + NSD_work::Trans + NSD_Trans::trans
000000r 2               .define	__trans_one	nsd_work + NSD_work::Trans + NSD_Trans::onetime
000000r 2               .define	__repeat_ctr	nsd_work + NSD_work::Repeat + NSD_Repeat::count1
000000r 2               .define	__repeat_ctr2	nsd_work + NSD_work::Repeat + NSD_Repeat::count2
000000r 2               .define	__volume	nsd_work + NSD_work::Volume + NSD_volume::volume
000000r 2               .define	__voice		nsd_work + NSD_work::Voice + NSD_voice::voice
000000r 2               .define	__voice_set	nsd_work + NSD_work::Voice + NSD_voice::voice_set
000000r 2               .define	__frequency	nsd_work + NSD_work::Frequency
000000r 2               .define	__frequency_set	nsd_work + NSD_work::Frequency_Set
000000r 2               .define	__subroutine	nsd_work + NSD_work::SubRoutine
000000r 2               .define	__repeat2	nsd_work + NSD_work::Repeat2
000000r 2               .define	__env_volume	nsd_work + NSD_work::Envelop_Volume
000000r 2               .define	__env_voice	nsd_work + NSD_work::Envelop_Voice
000000r 2               .define	__env_frequency	nsd_work + NSD_work::Envelop_Freq
000000r 2               .define	__env_note	nsd_work + NSD_work::Envelop_Note
000000r 2               .define	__env_vol_ptr	nsd_work + NSD_work::Env_V_Ptr + NSD_Env_V_Ptr::Volume
000000r 2               .define	__env_voi_ptr	nsd_work + NSD_work::Env_V_Ptr + NSD_Env_V_Ptr::Voice
000000r 2               .define	__env_freq_ptr	nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Frequency
000000r 2               .define	__env_note_ptr	nsd_work + NSD_work::Env_F_Ptr + NSD_Env_F_Ptr::Note
000000r 2               ;	voiceに関しては、その後の演算は無いので、更新されない場合はエンベロープ処理を終了する。
000000r 2               .define	__env_vol_now	nsd_work + NSD_work::Volume + NSD_volume::volume_env
000000r 2               .define	__env_freq_now	nsd_work + NSD_work::Env_F_Now + NSD_Env_F_Now::Frequency
000000r 2               .define	__env_note_now	nsd_work + NSD_work::Env_F_Now + NSD_Env_F_Now::Note
000000r 2               
000000r 2               .define	__sweep_ch1	nsd_work + NSD_work::Volume + NSD_volume::volume_env + nsd::TR_BGM3
000000r 2               .define	__sweep_ch2	nsd_work + NSD_work::Volume + NSD_volume::volume_env + nsd::TR_BGM5
000000r 2               
000000r 2               .define	__dpcm_info	nsd_work + NSD_work::Env_V_Ptr + nsd::TR_BGM5
000000r 2               
000000r 2               
000000r 2               ;=======================================================================
000000r 2               ;		Struct of DPCM					*
000000r 2               ;-----------------------------------------------------------------------
000000r 2               .Struct		nsd_dpcm
000000r 2               	Control		.byte		;I/O 0x4010
000000r 2               	DA		.byte		;I/O 0x4011
000000r 2               	Address		.byte		;I/O 0x4012
000000r 2               	Size		.byte		;I/O 0x4013
000000r 2               .Endstruct
000000r 2               
000000r 2               
000000r 2               
000000r 2               ;=======================================================================
000000r 2               ;	Macros
000000r 2               ;-----------------------------------------------------------------------
000000r 2               
000000r 2               .MACPACK generic
000000r 2               
000000r 2               .macro  ldax    arg
000000r 2               	.if (.match (.left (1, {arg}), #))
000000r 2               		; immediate mode
000000r 2               		lda     #<(.right (.tcount ({arg})-1, {arg}))
000000r 2               		ldx     #>(.right (.tcount ({arg})-1, {arg}))
000000r 2               	.else
000000r 2               		; assume absolute or zero page
000000r 2               		lda     arg
000000r 2               		ldx     1+(arg)
000000r 2               	.endif
000000r 2               .endmacro
000000r 2               
000000r 2               .macro  addw    Arg
000000r 2               	clc
000000r 2               	.if (.match (.left (1, {arg}), #))
000000r 2               		; immediate mode
000000r 2               		adc     #<(.right (.tcount ({arg})-1, {arg}))
000000r 2               		adc     #>(.right (.tcount ({arg})-1, {arg}))
000000r 2               	.else
000000r 2               		; assume absolute or zero page
000000r 2               		adc     arg
000000r 2               		adc     1+(arg)
000000r 2               	.endif
000000r 2               .endmacro
000000r 2               
000000r 2               .macro  subw    Arg
000000r 2               	sec
000000r 2               	.if (.match (.left (1, {arg}), #))
000000r 2               		; immediate mode
000000r 2               		sbc     #<(.right (.tcount ({arg})-1, {arg}))
000000r 2               		sbc     #>(.right (.tcount ({arg})-1, {arg}))
000000r 2               	.else
000000r 2               		; assume absolute or zero page
000000r 2               		sbc     arg
000000r 2               		sbc     1+(arg)
000000r 2               	.endif
000000r 2               .endmacro
000000r 2               
000000r 2               .macro	shl	arg, c
000000r 2               	.repeat	c
000000r 2               		asl	arg
000000r 2               	.endrepeat
000000r 2               .endmacro
000000r 2               
000000r 2               .macro	shr	arg, c
000000r 2               	.repeat	c
000000r 2               		lsr	arg
000000r 2               	.endrepeat
000000r 2               .endmacro
000000r 2               
000000r 2               
000000r 1               
000000r 1               ;=======================================================================
000000r 1               ;		nsd_keyon
000000r 1               ;-----------------------------------------------------------------------
000000r 1               ;<<Contents>>
000000r 1               ;	Key On
000000r 1               ;<<Input>>
000000r 1               ;	nothing
000000r 1               ;<<Output>>
000000r 1               ;	nothing
000000r 1               ;=======================================================================
000000r 1               .proc	nsd_keyon
000000r 1               
000000r 1               	;tai check
000000r 1  BD rr rr     	lda	__tai,x
000003r 1  29 02        	and	#$02
000005r 1  D0 37        	bne	exit
000007r 1               
000007r 1               	;Software envelop Key on
000007r 1  BD rr rr     	lda	__chflag,x
00000Ar 1  29 FC        	and	#~nsd_chflag::KeyOff
00000Cr 1  09 03        	ora	#nsd_chflag::KeyOff
00000Er 1  9D rr rr     	sta	__chflag,x
000011r 1               
000011r 1               	;Portamento
000011r 1  BD rr rr     	lda	__por_depth,x
000014r 1  D0 05        	bne	@L		;ポルタメントが終了していたら、無効化する。
000016r 1  A9 00        	lda	#0
000018r 1  9D rr rr     	sta	__por_target,x
00001Br 1               @L:
00001Br 1               
00001Br 1               	;Hardware key on
00001Br 1  20 rr rr     	jsr	_nsd_snd_keyon
00001Er 1               
00001Er 1  A9 00        	lda	#$00
000020r 1  95 rr        	sta	__Envelop_F,x
000022r 1  A9 01        	lda	#$01
000024r 1  9D rr rr     	sta	__env_freq_ptr,x
000027r 1  9D rr rr     	sta	__env_note_ptr,x
00002Ar 1               
00002Ar 1  E0 04        	cpx	#nsd::TR_BGM3
00002Cr 1  F0 10        	beq	exit
00002Er 1  E0 08        	cpx	#nsd::TR_BGM5
000030r 1  F0 0C        	beq	exit
000032r 1               
000032r 1  A9 00        	lda	#$00
000034r 1  95 rr        	sta	__Envelop_V,x
000036r 1  A9 01        	lda	#$01
000038r 1  9D rr rr     	sta	__env_voi_ptr,x
00003Br 1  9D rr rr     	sta	__env_vol_ptr,x
00003Er 1               
00003Er 1  60           exit:	rts
00003Fr 1               .endproc
00003Fr 1               
00003Fr 1               ;=======================================================================
00003Fr 1               ;		nsd_keyoff
00003Fr 1               ;-----------------------------------------------------------------------
00003Fr 1               ;<<Contents>>
00003Fr 1               ;	Key Off
00003Fr 1               ;<<Input>>
00003Fr 1               ;	nothing
00003Fr 1               ;<<Output>>
00003Fr 1               ;	nothing
00003Fr 1               ;=======================================================================
00003Fr 1               .proc	nsd_keyoff
00003Fr 1               
00003Fr 1               	; to do	tai check
00003Fr 1  BD rr rr     	lda	__tai,x
000042r 1  29 01        	and	#$01
000044r 1  D0 09        	bne	@E
000046r 1               
000046r 1  BD rr rr     	lda	__chflag,x
000049r 1  29 03        	and	#nsd_chflag::KeyOff
00004Br 1  C9 03        	cmp	#nsd_chflag::KeyOff
00004Dr 1  F0 01        	beq	@L			;Key Onの時のみ、処理。
00004Fr 1               
00004Fr 1  60           @E:	rts
000050r 1               @L:
000050r 1               	;Software key Off
000050r 1  BD rr rr     	lda	__chflag,x
000053r 1  29 FC        	and	#~nsd_chflag::KeyOff
000055r 1  1D rr rr     	ora	__gatemode,x
000058r 1  9D rr rr     	sta	__chflag,x
00005Br 1               
00005Br 1               	;Hardware key off
00005Br 1  20 rr rr     	jsr	_nsd_snd_keyoff
00005Er 1               
00005Er 1  A9 00        	lda	#$00
000060r 1  A8           	tay
000061r 1               ;	sta	__por_target,x		;Por off
000061r 1               
000061r 1               	;Frequency Envelop keyoff
000061r 1  BD rr rr     	lda	__env_frequency,x
000064r 1  85 rr        	sta	__ptr
000066r 1  BD rr rr     	lda	__env_frequency + 1,x
000069r 1  85 rr        	sta	__ptr + 1
00006Br 1  B1 rr        	lda	(__ptr),y
00006Dr 1  F0 09        	beq	Freq_End
00006Fr 1  9D rr rr     	sta	__env_freq_ptr,x
000072r 1  B5 rr        	lda	__Envelop_F,x
000074r 1  29 F0        	and	#$F0
000076r 1  95 rr        	sta	__Envelop_F,x
000078r 1               Freq_End:
000078r 1               
000078r 1               	;Note Envelop keyoff
000078r 1  BD rr rr     	lda	__env_note,x
00007Br 1  85 rr        	sta	__ptr
00007Dr 1  BD rr rr     	lda	__env_note + 1,x
000080r 1  85 rr        	sta	__ptr + 1
000082r 1  B1 rr        	lda	(__ptr),y
000084r 1  F0 09        	beq	Note_End
000086r 1  9D rr rr     	sta	__env_note_ptr,x
000089r 1  B5 rr        	lda	__Envelop_F,x
00008Br 1  29 0F        	and	#$0F
00008Dr 1  95 rr        	sta	__Envelop_F,x
00008Fr 1               Note_End:
00008Fr 1               
00008Fr 1  E0 04        	cpx	#nsd::TR_BGM3
000091r 1  F0 32        	beq	exit
000093r 1  E0 08        	cpx	#nsd::TR_BGM5
000095r 1  F0 2E        	beq	exit
000097r 1               
000097r 1               	;Voice Envelop keyoff
000097r 1  BD rr rr     	lda	__env_voice,x
00009Ar 1  85 rr        	sta	__ptr
00009Cr 1  BD rr rr     	lda	__env_voice + 1,x
00009Fr 1  85 rr        	sta	__ptr + 1
0000A1r 1  B1 rr        	lda	(__ptr),y
0000A3r 1  F0 09        	beq	Voice_End
0000A5r 1  9D rr rr     	sta	__env_voi_ptr,x
0000A8r 1  B5 rr        	lda	__Envelop_V,x
0000AAr 1  29 0F        	and	#$0F
0000ACr 1  95 rr        	sta	__Envelop_V,x
0000AEr 1               Voice_End:
0000AEr 1               
0000AEr 1               	;Volume Envelop keyoff
0000AEr 1  BD rr rr     	lda	__env_volume,x
0000B1r 1  85 rr        	sta	__ptr
0000B3r 1  BD rr rr     	lda	__env_volume + 1,x
0000B6r 1  85 rr        	sta	__ptr + 1
0000B8r 1  B1 rr        	lda	(__ptr),y
0000BAr 1  F0 09        	beq	Volume_End
0000BCr 1  9D rr rr     	sta	__env_vol_ptr,x
0000BFr 1  B5 rr        	lda	__Envelop_V,x
0000C1r 1  29 F0        	and	#$F0
0000C3r 1  95 rr        	sta	__Envelop_V,x
0000C5r 1               Volume_End:
0000C5r 1               
0000C5r 1  60           exit:	rts
0000C6r 1               .endproc
0000C6r 1               
0000C6r 1               ;=======================================================================
0000C6r 1               ;		nsd_load_sequence;
0000C6r 1               ;-----------------------------------------------------------------------
0000C6r 1               ;<<Contents>>
0000C6r 1               ;	read sequence data
0000C6r 1               ;<<Input>>
0000C6r 1               ;	x	Channel * 2
0000C6r 1               ;	nds_work.Sequence_ptr
0000C6r 1               ;<<Output>>
0000C6r 1               ;	a	sequence datq
0000C6r 1               ;=======================================================================
0000C6r 1               .proc	nsd_load_sequence
0000C6r 1  A1 rr        	lda	(__Sequence_ptr,x)
0000C8r 1  F6 rr        	inc	__Sequence_ptr,x
0000CAr 1  D0 02        	bne	exit
0000CCr 1  F6 rr        	inc	__Sequence_ptr + 1,x
0000CEr 1  60           exit:	rts
0000CFr 1               .endproc
0000CFr 1               
0000CFr 1               ;=======================================================================
0000CFr 1               ;	void	nsd_sequence(void);
0000CFr 1               ;-----------------------------------------------------------------------
0000CFr 1               ;<<Contents>>
0000CFr 1               ;	Play sequence and control gate time
0000CFr 1               ;<<Input>>
0000CFr 1               ;	x	Channel * 2
0000CFr 1               ;<<Output>>
0000CFr 1               ;	nothing
0000CFr 1               ;=======================================================================
0000CFr 1               .proc	nsd_sequence
0000CFr 1               
0000CFr 1               .rodata
000000r 1               
000000r 1  60           length:	.byte	96
000001r 1  48           	.byte	72
000002r 1  30           	.byte	48
000003r 1  24           	.byte	36
000004r 1  20           	.byte	32
000005r 1  18           	.byte	24
000006r 1  12           	.byte	18
000007r 1  10           	.byte	16
000008r 1  0C           	.byte	12
000009r 1  09           	.byte	9
00000Ar 1  08           	.byte	8
00000Br 1  06           	.byte	6
00000Cr 1  04           	.byte	4
00000Dr 1  03           	.byte	3
00000Er 1  02           	.byte	2
00000Fr 1  01           	.byte	1
000010r 1               
000010r 1  rr rr        opaddr:	.addr	nsd_op00
000012r 1  rr rr        	.addr	nsd_op01
000014r 1  rr rr        	.addr	nsd_op02
000016r 1  rr rr        	.addr	nsd_op03
000018r 1  rr rr        	.addr	nsd_op04
00001Ar 1  rr rr        	.addr	nsd_op05
00001Cr 1  rr rr        	.addr	nsd_op06
00001Er 1  rr rr        	.addr	nsd_op07
000020r 1  rr rr        	.addr	nsd_op08
000022r 1  rr rr        	.addr	nsd_op09
000024r 1  rr rr        	.addr	nsd_op0A
000026r 1  rr rr        	.addr	nsd_op0B
000028r 1  rr rr        	.addr	nsd_op0C
00002Ar 1  rr rr        	.addr	nsd_op0D
00002Cr 1  rr rr        	.addr	nsd_op0E
00002Er 1  rr rr        	.addr	nsd_op0F
000030r 1  rr rr        	.addr	nsd_op10
000032r 1  rr rr        	.addr	nsd_op11
000034r 1  rr rr        	.addr	nsd_op12
000036r 1  rr rr        	.addr	nsd_op13
000038r 1  rr rr        	.addr	nsd_op14
00003Ar 1  rr rr        	.addr	nsd_op15
00003Cr 1  rr rr        	.addr	nsd_op16
00003Er 1  rr rr        	.addr	nsd_op17
000040r 1  rr rr        	.addr	nsd_op18
000042r 1  rr rr        	.addr	nsd_op19
000044r 1  rr rr        	.addr	nsd_op1A
000046r 1  rr rr        	.addr	nsd_op1B
000048r 1  rr rr        	.addr	nsd_op1C
00004Ar 1  rr rr        	.addr	nsd_op1D
00004Cr 1  rr rr        	.addr	nsd_op1E
00004Er 1  rr rr        	.addr	nsd_op1F
000050r 1  rr rr        	.addr	nsd_op20
000052r 1  rr rr        	.addr	nsd_op21
000054r 1  rr rr        	.addr	nsd_op22
000056r 1  rr rr        	.addr	nsd_op23
000058r 1  rr rr        	.addr	nsd_op24
00005Ar 1  rr rr        	.addr	nsd_op25
00005Cr 1  rr rr        	.addr	nsd_op26
00005Er 1  rr rr        	.addr	nsd_op27
000060r 1  rr rr        	.addr	nsd_op28
000062r 1  rr rr        	.addr	nsd_op29
000064r 1  rr rr        	.addr	nsd_op2A
000066r 1  rr rr        	.addr	nsd_op2B
000068r 1  rr rr        	.addr	nsd_op2C
00006Ar 1  rr rr        	.addr	nsd_op2D
00006Cr 1  rr rr        	.addr	nsd_op2E
00006Er 1  rr rr        	.addr	nsd_op2F
000070r 1  rr rr        	.addr	nsd_op30
000072r 1  rr rr        	.addr	nsd_op31
000074r 1  rr rr        	.addr	nsd_op32
000076r 1  rr rr        	.addr	nsd_op33
000078r 1  rr rr        	.addr	nsd_op34
00007Ar 1  rr rr        	.addr	nsd_op35
00007Cr 1  rr rr        	.addr	nsd_op36
00007Er 1  rr rr        	.addr	nsd_op37
000080r 1  rr rr        	.addr	nsd_op38
000082r 1  rr rr        	.addr	nsd_op39
000084r 1  rr rr        	.addr	nsd_op3A
000086r 1  rr rr        	.addr	nsd_op3B
000088r 1  rr rr        	.addr	nsd_op3C
00008Ar 1  rr rr        	.addr	nsd_op3D
00008Cr 1  rr rr        	.addr	nsd_op3E
00008Er 1  rr rr        	.addr	nsd_op3F
000090r 1               
000090r 1               .code
0000CFr 1               
0000CFr 1               	;-------------------------------
0000CFr 1               	;now play?	(check: Sequence_ptr == 0 ?)	** upper 1 byte only **
0000CFr 1  B5 rr        	lda	__Sequence_ptr + 1,x
0000D1r 1  F0 7D        	beq	Exit
0000D3r 1               
0000D3r 1  86 rr        	stx	__channel		;channel <- x
0000D5r 1               
0000D5r 1               	;-------------------------------
0000D5r 1               	;Gatetime control
0000D5r 1               
0000D5r 1               	;length == gatetime q ?
0000D5r 1  D6 rr        	dec	__Length_ctr,x		;length--
0000D7r 1  B5 rr        	lda	__Length_ctr,x
0000D9r 1  D5 rr        	cmp	__Gate,x
0000DBr 1  D0 03        	bne	GateTime_Exit		; if(__Length_ctr == __Gate){
0000DDr 1  20 rr rr     	jsr	nsd_keyoff		; 	nsd_keyoff();
0000E0r 1               GateTime_Exit:				; }
0000E0r 1  B5 rr        	lda	__Length_ctr,x
0000E2r 1  D0 6C        	bne	Exit		; if(__Length_ctr != 0){ return(); };
0000E4r 1               
0000E4r 1               	;-------------------------------
0000E4r 1               	;Sequence		(length == 0)
0000E4r 1               Sequence:
0000E4r 1  20 rr rr     	jsr	nsd_load_sequence
0000E7r 1               
0000E7r 1  C9 80        	cmp	#$80
0000E9r 1  90 79        	bcc	Control			;a >= 80 ?
0000EBr 1               
0000EBr 1               	;-----------------------
0000EBr 1               	;op-code = 0x80 - 0xFF
0000EBr 1               Note:
0000EBr 1  A8           	tay	;save a to y
0000ECr 1               
0000ECr 1               	;-------
0000ECr 1               	;bit 4 check (Slur)
0000ECr 1               Chk_Slur:
0000ECr 1  18           	clc
0000EDr 1  29 10        	and	#$10
0000EFr 1  F0 01        	beq	@L
0000F1r 1  38           	sec
0000F2r 1  3E rr rr     @L:	rol	__tai,x
0000F5r 1               
0000F5r 1               	;-------
0000F5r 1               	;bit 5 check (Length )
0000F5r 1               Chk_Length:
0000F5r 1  98           	tya
0000F6r 1  29 20        	and	#$20
0000F8r 1  F0 06        	beq	@L
0000FAr 1  20 rr rr     	jsr	nsd_load_sequence
0000FDr 1  4C rr rr     	jmp	@E
000100r 1  BD rr rr     @L:	lda	__length,x
000103r 1  95 rr        @E:	sta	__Length_ctr,x
000105r 1               
000105r 1               	;-------
000105r 1               	;bit 6 check (Gate Time)
000105r 1               Chk_GateTime:
000105r 1  98           	tya
000106r 1  29 40        	and	#$40
000108r 1  F0 10        	beq	@L
00010Ar 1  20 rr rr     	jsr	nsd_load_sequence
00010Dr 1  85 rr        	sta	__tmp
00010Fr 1  B5 rr        	lda	__Length_ctr,x
000111r 1  38 E5 rr     	sub	__tmp			; a = __Length_ctr - __Gate;
000114r 1  B0 19        	bcs	@gateset		; if(a < 0){
000116r 1  A9 00        	lda	#$0			;    a = 0x0; //no gate
000118r 1  F0 15        	beq	@gateset		; }	// relative jump because "0"
00011Ar 1               @L:
00011Ar 1  BD rr rr     	lda	__gate_u,x		;if (__gate_u,x == 0) then @q
00011Dr 1  F0 0D        	beq	@q			;
00011Fr 1  B5 rr        	lda	__Length_ctr,x
000121r 1  38 FD rr rr  	sub	__gate_u,x		; a = __Length_ctr - __Gate
000125r 1  90 05        	bcc	@q			; if (a < 0) then @q
000127r 1  DD rr rr     	cmp	__gate_q,x		;
00012Ar 1  B0 03        	bcs	@gateset		; if( a < __gate_q){
00012Cr 1  BD rr rr     @q:	lda	__gate_q,x		;    a = __gate_q;
00012Fr 1               @gateset:				; }
00012Fr 1  95 rr        	sta	__Gate,x
000131r 1               
000131r 1               Calc_Note_Number:
000131r 1  98           	tya
000132r 1  29 0F        	and	#$0F
000134r 1  C9 0C        	cmp	#12
000136r 1  90 19        	bcc	NoteSet
000138r 1               
000138r 1  29 0F        @Rest:	and	#$0F
00013Ar 1  38 E9 0D     	sub	#$0D
00013Dr 1  85 rr        	sta	__tmp
00013Fr 1  BD rr rr     	lda	__tai,x
000142r 1  29 02        	and	#$02
000144r 1  D0 0A        	bne	Exit		;If tai then exit
000146r 1  BD rr rr     	lda	__chflag,x
000149r 1  29 FC        	and	#~nsd_chflag::KeyOff
00014Br 1  05 rr        	ora	__tmp
00014Dr 1  9D rr rr     	sta	__chflag,x
000150r 1               Exit:
000150r 1  60           	rts
000151r 1               
000151r 1               NoteSet:
000151r 1  18 7D rr rr  	add	__octave,x
000155r 1  18 7D rr rr  	add	__trans_one,x
000159r 1  9D rr rr     	sta	__note,x
00015Cr 1  A9 00        	lda	#0
00015Er 1  9D rr rr     	sta	__trans_one,x	;0 reset
000161r 1  4C rr rr     	jmp	nsd_keyon
000164r 1               
000164r 1               
000164r 1               
000164r 1               	;-----------------------
000164r 1               	;op-code = 0x00 - 0x7F
000164r 1               Control:
000164r 1  C9 40        	cmp	#$40
000166r 1  B0 0F        	bcs	Short_Control
000168r 1               	;---------------
000168r 1               	;op-code = 0x00 - 0x3F
000168r 1  0A           	asl
000169r 1  A8           	tay				;x <- a * 2
00016Ar 1  B9 rr rr     	lda	opaddr,y
00016Dr 1  85 rr        	sta	__ptr
00016Fr 1  B9 rr rr     	lda	opaddr + 1,y
000172r 1  85 rr        	sta	__ptr + 1
000174r 1  6C rr rr     	jmp	(__ptr)			;jump for each op-code
000177r 1               
000177r 1               	;---------------
000177r 1               	;op-code = 0x40 - 0x7F
000177r 1               Short_Control:
000177r 1               
000177r 1               	;---------------
000177r 1               	;op-code = 0x40 - 0x7F
000177r 1               	;---------------
000177r 1               	;0x40 - 0x4F
000177r 1  C9 50        op40:	cmp	#$50
000179r 1  B0 0C        	bcs	op50
00017Br 1  29 0F        	and	#$0F
00017Dr 1               	;Set default length
00017Dr 1  A8           	tay
00017Er 1  B9 rr rr     	lda	length,y
000181r 1  9D rr rr     	sta	__length,x		;__length = length[a & 0x0F];
000184r 1  4C rr rr     	jmp	Sequence
000187r 1               	;---------------
000187r 1               	;0x50 - 0x5F
000187r 1  C9 60        op50:	cmp	#$60
000189r 1  B0 08        	bcs	op60
00018Br 1  29 0F        	and	#$0F
00018Dr 1               	;Set gate time (1)
00018Dr 1  9D rr rr     	sta	__gate_q,x		;__gate_q = a & 0x0F;
000190r 1  4C rr rr     	jmp	Sequence
000193r 1               	;---------------
000193r 1               	;0x60 - 0x6F
000193r 1  C9 70        op60:	cmp	#$70
000195r 1  B0 11        	bcs	op70
000197r 1  29 0F        	and	#$0F
000199r 1               	;Set volume
000199r 1  85 rr        	sta	__tmp
00019Br 1  BD rr rr     	lda	__volume,x
00019Er 1  29 F0        	and	#$F0
0001A0r 1  05 rr        	ora	__tmp
0001A2r 1  9D rr rr     	sta	__volume,x		;__volume = (__volume & 0xF0) | (a & 0x0F);
0001A5r 1  4C rr rr     	jmp	Sequence
0001A8r 1               	;---------------
0001A8r 1               	;0x70 - 0x7F
0001A8r 1               op70:	;Ser release volume
0001A8r 1  0A 0A 0A 0A  	shl	a, 4
0001ACr 1  85 rr        	sta	__tmp
0001AEr 1  BD rr rr     	lda	__volume,x
0001B1r 1  29 0F        	and	#$0F
0001B3r 1  05 rr        	ora	__tmp
0001B5r 1  9D rr rr     	sta	__volume,x		;__volume = (__volume & 0x0F) | (a << 4);
0001B8r 1  4C rr rr     	jmp	Sequence
0001BBr 1               
0001BBr 1               ;=======================================================================
0001BBr 1               ;		opcode	0x00:	End of Track / End of Subroutine
0001BBr 1               ;-----------------------------------------------------------------------
0001BBr 1               nsd_op00:
0001BBr 1  BD rr rr     	lda	__subroutine + 1,x
0001BEr 1  95 rr        	sta	__Sequence_ptr + 1,x
0001C0r 1  F0 10        	beq	@L	;if (a == 0)
0001C2r 1  BD rr rr     	lda	__subroutine,x
0001C5r 1  95 rr        	sta	__Sequence_ptr,x	;戻るときは代入
0001C7r 1  A9 00        	lda	#0
0001C9r 1  9D rr rr     	sta	__subroutine,x
0001CCr 1  9D rr rr     	sta	__subroutine + 1,x
0001CFr 1  4C rr rr     	jmp	Sequence
0001D2r 1               @L:
0001D2r 1  95 rr        	sta	__Sequence_ptr,x
0001D4r 1               
0001D4r 1  BD rr rr     	lda	__chflag,x
0001D7r 1  29 FC        	and	#~nsd_chflag::KeyOff
0001D9r 1  9D rr rr     	sta	__chflag,x
0001DCr 1               ;
0001DCr 1               ;	Sweepの状態を元に戻す。
0001DCr 1               ;
0001DCr 1               @SE1:	;lda	__chflag,x
0001DCr 1  29 40        	and	#nsd_chflag::SE1
0001DEr 1  F0 09        	beq	@SE2
0001E0r 1  AD rr rr     	lda	__sweep_ch2
0001E3r 1  20 rr rr     	jsr	_nsd_snd_sweep
0001E6r 1  4C rr rr     	jmp	@Exit
0001E9r 1               
0001E9r 1               @SE2:	;SE2は無い。
0001E9r 1               
0001E9r 1               @Exit:
0001E9r 1  60           	rts
0001EAr 1               
0001EAr 1               ;=======================================================================
0001EAr 1               ;		opcode	0x02:	Sub-routine call
0001EAr 1               ;-----------------------------------------------------------------------
0001EAr 1               nsd_op02:
0001EAr 1  B5 rr        	lda	__Sequence_ptr,x
0001ECr 1  18 69 02     	add	#2
0001EFr 1  9D rr rr     	sta	__subroutine,x
0001F2r 1  B5 rr        	lda	__Sequence_ptr + 1,x
0001F4r 1  69 00        	adc	#0
0001F6r 1  9D rr rr     	sta	__subroutine + 1,x		;2byte先のポインタを記憶する。
0001F9r 1               
0001F9r 1               ;=======================================================================
0001F9r 1               ;		opcode	0x01:	Jump (End of Track with loop)
0001F9r 1               ;-----------------------------------------------------------------------
0001F9r 1               nsd_op01:
0001F9r 1               Jump:
0001F9r 1  B4 rr        	ldy	__Sequence_ptr,x
0001FBr 1  84 rr        	sty	__ptr			;
0001FDr 1  B4 rr        	ldy	__Sequence_ptr + 1,x
0001FFr 1  84 rr        	sty	__ptr + 1		;__ptr = __Sequence_ptr
000201r 1               
000201r 1  20 rr rr     	jsr	nsd_load_sequence
000204r 1  85 rr        	sta	__tmp
000206r 1  20 rr rr     	jsr	nsd_load_sequence
000209r 1  85 rr        	sta	__tmp + 1		;__tmp = value
00020Br 1               
00020Br 1  A5 rr        	lda	__ptr
00020Dr 1  18 65 rr     	add	__tmp
000210r 1  95 rr        	sta	__Sequence_ptr,x
000212r 1  A5 rr        	lda	__ptr + 1
000214r 1  65 rr        	adc	__tmp + 1
000216r 1  95 rr        	sta	__Sequence_ptr + 1,x	;__Sequence_ptr = __ptr + __tmp
000218r 1               
000218r 1  4C rr rr     	jmp	Sequence
00021Br 1               
00021Br 1               ;=======================================================================
00021Br 1               ;		opcode	0x03:	Repeat start.
00021Br 1               ;-----------------------------------------------------------------------
00021Br 1               nsd_op03:
00021Br 1  20 rr rr     	jsr	nsd_load_sequence
00021Er 1  9D rr rr     	sta	__repeat_ctr,x
000221r 1  4C rr rr     	jmp	Sequence
000224r 1               
000224r 1               ;=======================================================================
000224r 1               ;		opcode	0x04:	Repeat break.
000224r 1               ;-----------------------------------------------------------------------
000224r 1               nsd_op04:
000224r 1  BD rr rr     	lda	__repeat_ctr,x
000227r 1  C9 01        	cmp	#1
000229r 1  F0 CE        	beq	Jump
00022Br 1  20 rr rr     	jsr	nsd_load_sequence
00022Er 1  20 rr rr     	jsr	nsd_load_sequence
000231r 1  4C rr rr     	jmp	Sequence
000234r 1               
000234r 1               ;=======================================================================
000234r 1               ;		opcode	0x05:	Repeat end.
000234r 1               ;-----------------------------------------------------------------------
000234r 1               nsd_op05:
000234r 1  DE rr rr     	dec	__repeat_ctr,x
000237r 1  D0 C0        	bne	Jump
000239r 1  20 rr rr     	jsr	nsd_load_sequence
00023Cr 1  20 rr rr     	jsr	nsd_load_sequence
00023Fr 1               nsd_op06:
00023Fr 1  4C rr rr     	jmp	Sequence
000242r 1               
000242r 1               ;=======================================================================
000242r 1               ;		opcode	0x18:	Repeat start.
000242r 1               ;-----------------------------------------------------------------------
000242r 1               nsd_op18:
000242r 1  A9 00        	lda	#0			;counter <= 0
000244r 1  9D rr rr     	sta	__repeat_ctr2,x
000247r 1  4C rr rr     	jmp	Sequence
00024Ar 1               
00024Ar 1               ;=======================================================================
00024Ar 1               ;		opcode	0x19:	repeat 1 time point
00024Ar 1               ;-----------------------------------------------------------------------
00024Ar 1               nsd_op19:
00024Ar 1  BD rr rr     	lda	__repeat_ctr2,x
00024Dr 1  F0 0A        	beq	@exit			;counter == 0 だったら何もしない。
00024Fr 1  BD rr rr     	lda	__repeat2,x
000252r 1  95 rr        	sta	__Sequence_ptr,x
000254r 1  BD rr rr     	lda	__repeat2 + 1,x
000257r 1  95 rr        	sta	__Sequence_ptr + 1,x	;それ以外は、 :| の次にジャンプ
000259r 1               @exit:
000259r 1  4C rr rr     	jmp	Sequence
00025Cr 1               
00025Cr 1               ;=======================================================================
00025Cr 1               ;		opcode	0x1A:	Repeat end.
00025Cr 1               ;-----------------------------------------------------------------------
00025Cr 1               nsd_op1A:
00025Cr 1  FE rr rr     	inc	__repeat_ctr2,x		;counter ++
00025Fr 1               
00025Fr 1  B5 rr        	lda	__Sequence_ptr,x
000261r 1  18 69 02     	add	#2
000264r 1  9D rr rr     	sta	__repeat2,x
000267r 1  B5 rr        	lda	__Sequence_ptr + 1,x
000269r 1  69 00        	adc	#0
00026Br 1  9D rr rr     	sta	__repeat2 + 1,x		;2byte先のポインタを記憶する。
00026Er 1               
00026Er 1  4C rr rr     	jmp	Jump			;相対ジャンプへ
000271r 1               
000271r 1               ;=======================================================================
000271r 1               ;		opcode	0x07:	Write data to memory.
000271r 1               ;-----------------------------------------------------------------------
000271r 1               nsd_op07:
000271r 1  20 rr rr     	jsr	nsd_load_sequence
000274r 1  85 rr        	sta	__ptr
000276r 1  20 rr rr     	jsr	nsd_load_sequence
000279r 1  85 rr        	sta	__ptr + 1
00027Br 1  20 rr rr     	jsr	nsd_load_sequence
00027Er 1  A0 00        	ldy	#0
000280r 1  91 rr        	sta	(__ptr),y
000282r 1  4C rr rr     	jmp	Sequence
000285r 1               
000285r 1               ;=======================================================================
000285r 1               ;		opcode	0x08:	Tempo [BPM]
000285r 1               ;-----------------------------------------------------------------------
000285r 1               nsd_op08:
000285r 1  BD rr rr     	lda	__chflag,x
000288r 1  29 C0        	and	#nsd_chflag::SE1 + nsd_chflag::SE2
00028Ar 1  D0 08        	bne	Set_Tempo_SE
00028Cr 1  20 rr rr     	jsr	nsd_load_sequence
00028Fr 1               Set_Tempo:
00028Fr 1  85 rr        	sta	__Tempo
000291r 1  4C rr rr     	jmp	Sequence
000294r 1               Set_Tempo_SE:
000294r 1  20 rr rr     	jsr	nsd_load_sequence
000297r 1  4C rr rr     	jmp	Sequence
00029Ar 1               ;=======================================================================
00029Ar 1               ;		opcode	0x0C:	Relative Tempo [BPM]
00029Ar 1               ;-----------------------------------------------------------------------
00029Ar 1               nsd_op0C:
00029Ar 1  BD rr rr     	lda	__chflag,x
00029Dr 1  29 C0        	and	#nsd_chflag::SE1 + nsd_chflag::SE2
00029Fr 1  D0 F3        	bne	Set_Tempo_SE
0002A1r 1  20 rr rr     	jsr	nsd_load_sequence
0002A4r 1  18 65 rr     	add	__Tempo
0002A7r 1  4C rr rr     	jmp	Set_Tempo
0002AAr 1               ;=======================================================================
0002AAr 1               ;		opcode	0x09:	Note length of 省略時 [Ticks]
0002AAr 1               ;-----------------------------------------------------------------------
0002AAr 1               nsd_op09:
0002AAr 1  20 rr rr     	jsr	nsd_load_sequence
0002ADr 1  9D rr rr     	sta	__length,x
0002B0r 1  4C rr rr     	jmp	Sequence
0002B3r 1               
0002B3r 1               ;=======================================================================
0002B3r 1               ;		opcode	0x0A:	Gate time (key-off timing from last)
0002B3r 1               ;-----------------------------------------------------------------------
0002B3r 1               nsd_op0A:
0002B3r 1  20 rr rr     	jsr	nsd_load_sequence
0002B6r 1  9D rr rr     	sta	__gate_q,x
0002B9r 1  4C rr rr     	jmp	Sequence
0002BCr 1               
0002BCr 1               ;=======================================================================
0002BCr 1               ;		opcode	0x0B:	Gate time (length of 発音)
0002BCr 1               ;-----------------------------------------------------------------------
0002BCr 1               nsd_op0B:
0002BCr 1  20 rr rr     	jsr	nsd_load_sequence
0002BFr 1  9D rr rr     	sta	__gate_u,x
0002C2r 1  4C rr rr     	jmp	Sequence
0002C5r 1               
0002C5r 1               ;=======================================================================
0002C5r 1               ;		opcode	0x0D:	gate mode	(vol = 0)
0002C5r 1               ;-----------------------------------------------------------------------
0002C5r 1               nsd_op0D:
0002C5r 1  A9 00        	lda	#$00
0002C7r 1  9D rr rr     	sta	__gatemode,x
0002CAr 1  4C rr rr     	jmp	Sequence
0002CDr 1               ;=======================================================================
0002CDr 1               ;		opcode	0x0E:	gate mode
0002CDr 1               ;-----------------------------------------------------------------------
0002CDr 1               nsd_op0E:
0002CDr 1  A9 01        	lda	#$01
0002CFr 1  9D rr rr     	sta	__gatemode,x
0002D2r 1  4C rr rr     	jmp	Sequence
0002D5r 1               ;=======================================================================
0002D5r 1               ;		opcode	0x0F:	gate mode	(release)
0002D5r 1               ;-----------------------------------------------------------------------
0002D5r 1               nsd_op0F:
0002D5r 1  A9 02        	lda	#$02
0002D7r 1  9D rr rr     	sta	__gatemode,x
0002DAr 1  4C rr rr     	jmp	Sequence
0002DDr 1               
0002DDr 1               ;=======================================================================
0002DDr 1               ;		opcode	0x10:	Voice envelop.
0002DDr 1               ;-----------------------------------------------------------------------
0002DDr 1               nsd_op10:
0002DDr 1  B4 rr        	ldy	__Sequence_ptr,x
0002DFr 1  84 rr        	sty	__ptr			;
0002E1r 1  B4 rr        	ldy	__Sequence_ptr + 1,x
0002E3r 1  84 rr        	sty	__ptr + 1		;__ptr = __Sequence_ptr
0002E5r 1               
0002E5r 1  20 rr rr     	jsr	nsd_load_sequence
0002E8r 1  85 rr        	sta	__tmp
0002EAr 1  20 rr rr     	jsr	nsd_load_sequence
0002EDr 1  85 rr        	sta	__tmp + 1		;__tmp = value
0002EFr 1               
0002EFr 1  E0 04        	cpx	#nsd::TR_BGM3
0002F1r 1  F0 18        	beq	@Exit
0002F3r 1  E0 08        	cpx	#nsd::TR_BGM5
0002F5r 1  F0 14        	beq	@Exit
0002F7r 1               
0002F7r 1  A5 rr        	lda	__ptr
0002F9r 1  18 65 rr     	add	__tmp
0002FCr 1  9D rr rr     	sta	__env_voice,x
0002FFr 1  A5 rr        	lda	__ptr + 1
000301r 1  65 rr        	adc	__tmp + 1
000303r 1  9D rr rr     @Zero:	sta	__env_voice + 1,x	;__env_voice = __ptr + __tmp
000306r 1               
000306r 1  A9 01        	lda	#$01
000308r 1  9D rr rr     	sta	__env_voi_ptr,x
00030Br 1               @Exit:
00030Br 1  4C rr rr     	jmp	Sequence
00030Er 1               
00030Er 1               ;=======================================================================
00030Er 1               ;		opcode	0x11:	Volume envelop.
00030Er 1               ;-----------------------------------------------------------------------
00030Er 1               nsd_op11:
00030Er 1  B4 rr        	ldy	__Sequence_ptr,x
000310r 1  84 rr        	sty	__ptr			;
000312r 1  B4 rr        	ldy	__Sequence_ptr + 1,x
000314r 1  84 rr        	sty	__ptr + 1		;__ptr = __Sequence_ptr
000316r 1               
000316r 1  20 rr rr     	jsr	nsd_load_sequence
000319r 1  85 rr        	sta	__tmp
00031Br 1  20 rr rr     	jsr	nsd_load_sequence
00031Er 1  85 rr        	sta	__tmp + 1		;__tmp = value
000320r 1               
000320r 1  E0 04        	cpx	#nsd::TR_BGM3
000322r 1  F0 1C        	beq	@Exit
000324r 1  E0 08        	cpx	#nsd::TR_BGM5
000326r 1  F0 18        	beq	@Exit
000328r 1               
000328r 1  05 rr        	ora	__tmp
00032Ar 1  F0 0C        	beq	@Zero
00032Cr 1               
00032Cr 1  A5 rr        	lda	__ptr
00032Er 1  18 65 rr     	add	__tmp
000331r 1  9D rr rr     	sta	__env_volume,x
000334r 1  A5 rr        	lda	__ptr + 1
000336r 1  65 rr        	adc	__tmp + 1
000338r 1  9D rr rr     @Zero:	sta	__env_volume + 1,x
00033Br 1               
00033Br 1  A9 01        	lda	#$01
00033Dr 1  9D rr rr     	sta	__env_vol_ptr,x
000340r 1               @Exit:
000340r 1  4C rr rr     	jmp	Sequence
000343r 1               
000343r 1               ;=======================================================================
000343r 1               ;		opcode	0x12:	Frequency envelop.
000343r 1               ;-----------------------------------------------------------------------
000343r 1               nsd_op12:
000343r 1  B4 rr        	ldy	__Sequence_ptr,x
000345r 1  84 rr        	sty	__ptr			;
000347r 1  B4 rr        	ldy	__Sequence_ptr + 1,x
000349r 1  84 rr        	sty	__ptr + 1		;__ptr = __Sequence_ptr
00034Br 1               
00034Br 1  20 rr rr     	jsr	nsd_load_sequence
00034Er 1  85 rr        	sta	__tmp
000350r 1  20 rr rr     	jsr	nsd_load_sequence
000353r 1  85 rr        	sta	__tmp + 1		;__tmp = value
000355r 1               
000355r 1  05 rr        	ora	__tmp
000357r 1  F0 0C        	beq	@Zero
000359r 1               
000359r 1  A5 rr        	lda	__ptr
00035Br 1  18 65 rr     	add	__tmp
00035Er 1  9D rr rr     	sta	__env_frequency,x
000361r 1  A5 rr        	lda	__ptr + 1
000363r 1  65 rr        	adc	__tmp + 1
000365r 1  9D rr rr     @Zero:	sta	__env_frequency + 1,x
000368r 1               
000368r 1  A9 01        	lda	#$01
00036Ar 1  9D rr rr     	sta	__env_freq_ptr,x
00036Dr 1               @Exit:
00036Dr 1  4C rr rr     	jmp	Sequence
000370r 1               
000370r 1               ;=======================================================================
000370r 1               ;		opcode	0x13:	Note envelop.
000370r 1               ;-----------------------------------------------------------------------
000370r 1               nsd_op13:
000370r 1  B4 rr        	ldy	__Sequence_ptr,x
000372r 1  84 rr        	sty	__ptr			;
000374r 1  B4 rr        	ldy	__Sequence_ptr + 1,x
000376r 1  84 rr        	sty	__ptr + 1		;__ptr = __Sequence_ptr
000378r 1               
000378r 1  20 rr rr     	jsr	nsd_load_sequence
00037Br 1  85 rr        	sta	__tmp
00037Dr 1  20 rr rr     	jsr	nsd_load_sequence
000380r 1  85 rr        	sta	__tmp + 1		;__tmp = value
000382r 1               
000382r 1  05 rr        	ora	__tmp
000384r 1  F0 0C        	beq	@Zero
000386r 1               
000386r 1  A5 rr        	lda	__ptr
000388r 1  18 65 rr     	add	__tmp
00038Br 1  9D rr rr     	sta	__env_note,x
00038Er 1  A5 rr        	lda	__ptr + 1
000390r 1  65 rr        	adc	__tmp + 1
000392r 1  9D rr rr     @Zero:	sta	__env_note + 1,x
000395r 1               
000395r 1  A9 01        	lda	#$01
000397r 1  9D rr rr     	sta	__env_note_ptr,x
00039Ar 1               @Exit:
00039Ar 1  4C rr rr     	jmp	Sequence
00039Dr 1               
00039Dr 1               ;=======================================================================
00039Dr 1               ;		opcode	0x14:	Detune (16 = 100 cent)
00039Dr 1               ;-----------------------------------------------------------------------
00039Dr 1               nsd_op14:
00039Dr 1  20 rr rr     	jsr	nsd_load_sequence
0003A0r 1  9D rr rr     	sta	__detune_cent,x
0003A3r 1  4C rr rr     	jmp	Sequence
0003A6r 1               
0003A6r 1               ;=======================================================================
0003A6r 1               ;		opcode	0x15:	Detune (Resister base)
0003A6r 1               ;-----------------------------------------------------------------------
0003A6r 1               nsd_op15:
0003A6r 1  20 rr rr     	jsr	nsd_load_sequence
0003A9r 1  9D rr rr     	sta	__detune_fine,x
0003ACr 1  4C rr rr     	jmp	Sequence
0003AFr 1               
0003AFr 1               ;=======================================================================
0003AFr 1               ;		opcode	0x16:	Sweep (Resister base)
0003AFr 1               ;-----------------------------------------------------------------------
0003AFr 1               nsd_op16:
0003AFr 1  20 rr rr     	jsr	nsd_load_sequence
0003B2r 1  20 rr rr     	jsr	_nsd_snd_sweep
0003B5r 1  4C rr rr     	jmp	Sequence
0003B8r 1               
0003B8r 1               ;=======================================================================
0003B8r 1               ;		opcode	0x17:	Portamento (Frequency += n2, every n3 [VBlank])
0003B8r 1               ;-----------------------------------------------------------------------
0003B8r 1               nsd_op17:
0003B8r 1  20 rr rr     	jsr	nsd_load_sequence	;decay
0003BBr 1  9D rr rr     	sta	__por_ctr,x
0003BEr 1  20 rr rr     	jsr	nsd_load_sequence	;rate
0003C1r 1  9D rr rr     	sta	__por_rate,x
0003C4r 1  20 rr rr     	jsr	nsd_load_sequence	;depth
0003C7r 1  9D rr rr     	sta	__por_depth,x
0003CAr 1  20 rr rr     	jsr	nsd_load_sequence	;target
0003CDr 1  9D rr rr     	sta	__por_target,x
0003D0r 1               
0003D0r 1  A9 00        	lda	#0
0003D2r 1  9D rr rr     	sta	__por_now + 0,x
0003D5r 1  9D rr rr     	sta	__por_now + 1,x		;現在の変位
0003D8r 1               
0003D8r 1  4C rr rr     	jmp	Sequence
0003DBr 1               
0003DBr 1               ;=======================================================================
0003DBr 1               ;		opcode	0x1B:	Voice
0003DBr 1               ;-----------------------------------------------------------------------
0003DBr 1               nsd_op1B:
0003DBr 1  A9 00        	lda	#0
0003DDr 1  9D rr rr     	sta	__env_voice + 1,x
0003E0r 1  20 rr rr     	jsr	nsd_load_sequence
0003E3r 1  9D rr rr     	sta	__env_voice,x
0003E6r 1               nsd_op1C:
0003E6r 1               nsd_op1D:
0003E6r 1               nsd_op1E:
0003E6r 1               nsd_op1F:
0003E6r 1  4C rr rr     	jmp	Sequence
0003E9r 1               
0003E9r 1               ;=======================================================================
0003E9r 1               ;		opcode	0x20:	Volume down (-1)
0003E9r 1               ;-----------------------------------------------------------------------
0003E9r 1               nsd_op20:
0003E9r 1  BD rr rr     	lda	__volume,x
0003ECr 1  29 0F        	and	#$0F
0003EEr 1  F0 03        	beq	@L
0003F0r 1  DE rr rr     	dec	__volume,x
0003F3r 1               @L:
0003F3r 1  4C rr rr     	jmp	Sequence
0003F6r 1               
0003F6r 1               ;=======================================================================
0003F6r 1               ;		opcode	0x21:	Volume up (+1)
0003F6r 1               ;-----------------------------------------------------------------------
0003F6r 1               nsd_op21:
0003F6r 1  BD rr rr     	lda	__volume,x
0003F9r 1  29 0F        	and	#$0F
0003FBr 1  C9 0F        	cmp	#$0F
0003FDr 1  F0 03        	beq	@L
0003FFr 1  FE rr rr     	inc	__volume,x
000402r 1               @L:
000402r 1               nsd_op22:
000402r 1               nsd_op23:
000402r 1               nsd_op24:
000402r 1               nsd_op25:
000402r 1               nsd_op26:
000402r 1               nsd_op27:
000402r 1  4C rr rr     	jmp	Sequence
000405r 1               
000405r 1               ;=======================================================================
000405r 1               ;		opcode	0x2A:	Transpose (an absolute value)
000405r 1               ;-----------------------------------------------------------------------
000405r 1               nsd_op2A:
000405r 1  20 rr rr     	jsr	nsd_load_sequence
000408r 1               nsd_Set_Trans:
000408r 1  9D rr rr     	sta	__trans,x
00040Br 1  4C rr rr     	jmp	Sequence
00040Er 1               
00040Er 1               ;=======================================================================
00040Er 1               ;		opcode	0x2B:	Transpose (a relative value)
00040Er 1               ;-----------------------------------------------------------------------
00040Er 1               nsd_op2B:
00040Er 1  20 rr rr     	jsr	nsd_load_sequence
000411r 1  18 7D rr rr  	add	__trans,x
000415r 1  4C rr rr     	jmp	nsd_Set_Trans
000418r 1               
000418r 1               ;=======================================================================
000418r 1               ;		opcode	0x2C:	One time octave down (-1)
000418r 1               ;-----------------------------------------------------------------------
000418r 1               nsd_op2C:
000418r 1  A9 F4        	lda	#-12
00041Ar 1  D0 07        	bne	nsd_Set_Trans_One
00041Cr 1               ;=======================================================================
00041Cr 1               ;		opcode	0x2D:	One time octave up (+1)
00041Cr 1               ;-----------------------------------------------------------------------
00041Cr 1               nsd_op2D:
00041Cr 1  A9 0C        	lda	#+12
00041Er 1  D0 03        	bne	nsd_Set_Trans_One
000420r 1               ;=======================================================================
000420r 1               ;		opcode	0x2E:	One time transpose (a relative value)
000420r 1               ;-----------------------------------------------------------------------
000420r 1               nsd_op2E:
000420r 1  20 rr rr     	jsr	nsd_load_sequence
000423r 1               nsd_Set_Trans_One:
000423r 1  18 7D rr rr  	add	__trans_one,x
000427r 1  9D rr rr     	sta	__trans_one,x
00042Ar 1               nsd_op2F:
00042Ar 1  4C rr rr     	jmp	Sequence
00042Dr 1               
00042Dr 1               ;=======================================================================
00042Dr 1               ;		opcode	0x30 - 0x37:	Voice of release (after key-off)
00042Dr 1               ;-----------------------------------------------------------------------
00042Dr 1               nsd_op30:
00042Dr 1  A9 00        	lda	#$00
00042Fr 1               nsd_Set_Voice:
00042Fr 1  85 rr        	sta	__tmp
000431r 1  BD rr rr     	lda	__voice,x
000434r 1  29 0F        	and	#$0F
000436r 1  05 rr        	ora	__tmp
000438r 1  9D rr rr     	sta	__voice,x
00043Br 1  4C rr rr     	jmp	Sequence
00043Er 1               
00043Er 1               nsd_op31:
00043Er 1  A9 10        	lda	#$10
000440r 1  D0 ED        	bne	nsd_Set_Voice
000442r 1               
000442r 1               nsd_op32:
000442r 1  A9 20        	lda	#$20
000444r 1  D0 E9        	bne	nsd_Set_Voice
000446r 1               
000446r 1               nsd_op33:
000446r 1  A9 30        	lda	#$30
000448r 1  D0 E5        	bne	nsd_Set_Voice
00044Ar 1               
00044Ar 1               nsd_op34:
00044Ar 1  A9 40        	lda	#$40
00044Cr 1  D0 E1        	bne	nsd_Set_Voice
00044Er 1               
00044Er 1               nsd_op35:
00044Er 1  A9 50        	lda	#$50
000450r 1  D0 DD        	bne	nsd_Set_Voice
000452r 1               
000452r 1               nsd_op36:
000452r 1  A9 60        	lda	#$60
000454r 1  D0 D9        	bne	nsd_Set_Voice
000456r 1               
000456r 1               nsd_op37:
000456r 1  A9 70        	lda	#$70
000458r 1  D0 D5        	bne	nsd_Set_Voice
00045Ar 1               
00045Ar 1               ;=======================================================================
00045Ar 1               ;		opcode	0x29:	Octave up (+1)
00045Ar 1               ;-----------------------------------------------------------------------
00045Ar 1               nsd_op29:
00045Ar 1  BD rr rr     	lda	__octave,x
00045Dr 1  18 69 0C     	add	#12
000460r 1  10 0B        	bpl	nsd_Set_Octave
000462r 1  4C rr rr     	jmp	Sequence
000465r 1               
000465r 1               ;=======================================================================
000465r 1               ;		opcode	0x28:	Octave down (-1)
000465r 1               ;-----------------------------------------------------------------------
000465r 1               nsd_op28:
000465r 1  BD rr rr     	lda	__octave,x
000468r 1  38 E9 0C     	sub	#12
00046Br 1  30 03        	bmi	nsd_op28_Exit
00046Dr 1               nsd_Set_Octave:
00046Dr 1  9D rr rr     	sta	__octave,x
000470r 1               nsd_op28_Exit:
000470r 1  4C rr rr     	jmp	Sequence
000473r 1               
000473r 1               ;=======================================================================
000473r 1               ;		opcode	0x38 - 0x3F:	Octave
000473r 1               ;-----------------------------------------------------------------------
000473r 1               nsd_op38:
000473r 1  A9 0C        	lda	#12
000475r 1  D0 F6        	bne	nsd_Set_Octave
000477r 1               
000477r 1               nsd_op39:
000477r 1  A9 18        	lda	#24
000479r 1  D0 F2        	bne	nsd_Set_Octave
00047Br 1               
00047Br 1               nsd_op3A:
00047Br 1  A9 24        	lda	#36
00047Dr 1  D0 EE        	bne	nsd_Set_Octave
00047Fr 1               
00047Fr 1               nsd_op3B:
00047Fr 1  A9 30        	lda	#48
000481r 1  D0 EA        	bne	nsd_Set_Octave
000483r 1               
000483r 1               nsd_op3C:
000483r 1  A9 3C        	lda	#60
000485r 1  D0 E6        	bne	nsd_Set_Octave
000487r 1               
000487r 1               nsd_op3D:
000487r 1  A9 48        	lda	#72
000489r 1  D0 E2        	bne	nsd_Set_Octave
00048Br 1               
00048Br 1               nsd_op3E:
00048Br 1  A9 54        	lda	#84
00048Dr 1  D0 DE        	bne	nsd_Set_Octave
00048Fr 1               
00048Fr 1               nsd_op3F:
00048Fr 1  A9 60        	lda	#96
000491r 1  D0 DA        	bne	nsd_Set_Octave
000493r 1               
000493r 1               .endproc
000493r 1               
000493r 1               
